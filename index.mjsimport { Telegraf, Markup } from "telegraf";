cd /Users/rodrigo/Projects/locione-telegram-bot
nano index.mjimport { Telegraf, Markup } from "telegraf";
import "dotenv/config";
import fs from "node:fs";
import path from "node:path";

const bot = new Telegraf(process.env.BOT_TOKEN);

// ===== PersistÃªncia local (JSON) =====
const DATA_DIR = process.cwd();
const STATS_FILE = path.join(DATA_DIR, "stats.json");
const SUBS_FILE = path.join(DATA_DIR, "subscribers.json");

function readJson(file, fallback) {
  try {
    return JSON.parse(fs.readFileSync(file, "utf8"));
  } catch {
    return fallback;
  }
}
function writeJson(file, data) {
  fs.writeFileSync(file, JSON.stringify(data, null, 2), "utf8");
}

function incStat(key) {
  const stats = readJson(STATS_FILE, {});
  stats[key] = (stats[key] || 0) + 1;
  writeJson(STATS_FILE, stats);
}

function addSubscriber(chatId) {
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  if (!subs.chat_ids.includes(chatId)) {
    subs.chat_ids.push(chatId);
    writeJson(SUBS_FILE, subs);
    return true;
  }
  return false;
}

function removeSubscriber(chatId) {
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  const before = subs.chat_ids.length;
  subs.chat_ids = subs.chat_ids.filter((id) => id !== chatId);
  writeJson(SUBS_FILE, subs);
  return subs.chat_ids.length !== before;
}

// ===== UTM builder =====
function withUtm(url, { campaign, medium = "bot", source = "telegram" }) {
  // sÃ³ faz sentido em URLs locione.com (ou qualquer URL sua)
  const u = new URL(url);
  u.searchParams.set("utm_source", source);
  u.searchParams.set("utm_medium", medium);
  u.searchParams.set("utm_campaign", campaign);
  return u.toString();
}

// ===== Links oficiais (com UTM onde dÃ¡) =====
// App Store: UTM nÃ£o serve pro seu analytics; mantemos link limpo.
// locione.com: UTM aplicado.
const LINKS = {
  finance_ios: "https://apps.apple.com/it/app/locione-finance/id6758838032",
  desk_download: withUtm("https://locione.com/download", { campaign: "locione_desk" }),
  site: withUtm("https://locione.com", { campaign: "locione_site" }),
  canal: "https://t.me/locione_app",
};

// ===== Menu principal =====
function mainMenu() {
  return Markup.inlineKeyboard([
    [Markup.button.callback("ðŸ“± LociOne Finance", "app_finance")],
    [Markup.button.callback("ðŸ’» LociOne Desk", "app_desk")],
    [Markup.button.url("ðŸŒ Site oficial", LINKS.site)],
    [Markup.button.url("ðŸ“£ Canal de novidades", LINKS.canal)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
  ]);
}

/**
 * Evita erro Telegram 400 "message can't be edited"
 */
async function safeEditOrReply(ctx, text, extra) {
  try {
    if (ctx.update?.callback_query) {
      await ctx.editMessageText(text, extra);
      return;
    }
  } catch (_) {}
  return ctx.reply(text, extra);
}

// ===== Telas =====
async function showFinance(ctx) {
  incStat("open_finance");
  const text =
    "*LociOne Finance ðŸ“±*\n\n" +
    "â€¢ Controle financeiro rÃ¡pido\n" +
    "â€¢ Offline-first (dados no aparelho)\n" +
    "â€¢ RelatÃ³rios e organizaÃ§Ã£o\n\n" +
    "Baixe no iOS:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸŽ App Store (iOS)", LINKS.finance_ios)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

async function showDesk(ctx) {
  incStat("open_desk");
  const text =
    "*LociOne Desk ðŸ’»*\n\n" +
    "â€¢ App desktop offline-first\n" +
    "â€¢ Produtividade com privacidade\n" +
    "â€¢ Downloads oficiais no site\n\n" +
    "FaÃ§a o download:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸ’» Download Desktop", LINKS.desk_download)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

// ===== /start com deep link payload =====
bot.start(async (ctx) => {
  incStat("start");
  const payload = (ctx.startPayload || "").trim();

  if (payload === "finance") return showFinance(ctx);
  if (payload === "desk") return showDesk(ctx);

  return ctx.reply(
    "ðŸ‘‹ *Bem-vindo Ã  LociOne!*\n\nEscolha o app que vocÃª quer conhecer:",
    { parse_mode: "Markdown", ...mainMenu() }
  );
});

// ===== Comandos =====
bot.command("finance", (ctx) => showFinance(ctx));
bot.command("desk", (ctx) => showDesk(ctx));
bot.command("site", (ctx) => {
  incStat("click_site_cmd");
  return ctx.reply(`ðŸŒ Site oficial: ${LINKS.site}`);
});
bot.command("canal", (ctx) => {
  incStat("click_canal_cmd");
  return ctx.reply(`ðŸ“£ Canal de novidades: ${LINKS.canal}`);
});

bot.command("stats", (ctx) => {
  const stats = readJson(STATS_FILE, {});
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  const lines = Object.entries(stats)
    .sort((a, b) => b[1] - a[1])
    .map(([k, v]) => `â€¢ ${k}: ${v}`);
  return ctx.reply(
    `ðŸ“Š *Stats*\n\n${lines.length ? lines.join("\n") : "Sem dados ainda."}\n\nðŸ‘¥ inscritos: ${subs.chat_ids.length}`,
    { parse_mode: "Markdown" }
  );
});

bot.command("subscribe", (ctx) => {
  const ok = addSubscriber(ctx.chat.id);
  incStat(ok ? "sub_on_cmd_new" : "sub_on_cmd_existing");
  return ctx.reply(ok ? "âœ… Inscrito nas novidades." : "âœ… VocÃª jÃ¡ estÃ¡ inscrito.");
});

bot.command("unsubscribe", (ctx) => {
  const ok = removeSubscriber(ctx.chat.id);
  incStat(ok ? "sub_off_cmd" : "sub_off_cmd_noop");
  return ctx.reply(ok ? "ðŸ›‘ InscriÃ§Ã£o removida." : "VocÃª nÃ£o estava inscrito.");
});

// ===== BotÃµes =====
bot.action("app_finance", (ctx) => showFinance(ctx));
bot.action("app_desk", (ctx) => showDesk(ctx));

bot.action("sub_on", async (ctx) => {
  const ok = addSubscriber(ctx.chat.id);
  incStat(ok ? "sub_on_new" : "sub_on_existing");
  try {
    await ctx.answerCbQuery(ok ? "Inscrito âœ…" : "VocÃª jÃ¡ estava inscrito âœ…", { show_alert: false });
  } catch {}
  return safeEditOrReply(
    ctx,
    ok ? "âœ… Pronto â€” vocÃª vai receber novidades quando eu enviar." : "âœ… VocÃª jÃ¡ estÃ¡ inscrito nas novidades.",
    { ...mainMenu() }
  );
});

bot.action("back", async (ctx) => {
  try {
    await ctx.editMessageText("Escolha o app que vocÃª quer conhecer:", mainMenu());
  } catch (_) {
    await ctx.reply("Escolha o app que vocÃª quer conhecer:", mainMenu());
  }
});

// ===== Erros =====
bot.catch((err) => console.error("Bot error:", err));

// ===== Start =====
bot.launch();
console.log("ðŸ¤– LociOne Bot rodando (polling)...");
console.log("Deep links:");
console.log(" - https://t.me/locione_bot?start=finance");
console.log(" - https://t.me/locione_bot?start=desk");

process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));import "dotenv/config";
import fs from "node:fs";
import path from "node:path";

const bot = new Telegraf(process.env.BOT_TOKEN);

// ===== PersistÃªncia local (JSON) =====
const DATA_DIR = process.cwd();
const STATS_FILE = path.join(DATA_DIR, "stats.json");
const SUBS_FILE = path.join(DATA_DIR, "subscribers.json");

function readJson(file, fallback) {
  try {
    return JSON.parse(fs.readFileSync(file, "utf8"));
  } catch {
    return fallback;
  }
}
function writeJson(file, data) {
  fs.writeFileSync(file, JSON.stringify(data, null, 2), "utf8");
}

function incStat(key) {
  const stats = readJson(STATS_FILE, {});
  stats[key] = (stats[key] || 0) + 1;
  writeJson(STATS_FILE, stats);
}

function addSubscriber(chatId) {
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  if (!subs.chat_ids.includes(chatId)) {
    subs.chat_ids.push(chatId);
    writeJson(SUBS_FILE, subs);
    return true;
  }
  return false;
}

function removeSubscriber(chatId) {
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  const before = subs.chat_ids.length;
  subs.chat_ids = subs.chat_ids.filter((id) => id !== chatId);
  writeJson(SUBS_FILE, subs);
  return subs.chat_ids.length !== before;
}

// ===== UTM builder =====
function withUtm(url, { campaign, medium = "bot", source = "telegram" }) {
  // sÃ³ faz sentido em URLs locione.com (ou qualquer URL sua)
  const u = new URL(url);
  u.searchParams.set("utm_source", source);
  u.searchParams.set("utm_medium", medium);
  u.searchParams.set("utm_campaign", campaign);
  return u.toString();
}

// ===== Links oficiais (com UTM onde dÃ¡) =====
// App Store: UTM nÃ£o serve pro seu analytics; mantemos link limpo.
// locione.com: UTM aplicado.
const LINKS = {
  finance_ios: "https://apps.apple.com/it/app/locione-finance/id6758838032",
  desk_download: withUtm("https://locione.com/download", { campaign: "locione_desk" }),
  site: withUtm("https://locione.com", { campaign: "locione_site" }),
  canal: "https://t.me/locione_app",
};

// ===== Menu principal =====
function mainMenu() {
  return Markup.inlineKeyboard([
    [Markup.button.callback("ðŸ“± LociOne Finance", "app_finance")],
    [Markup.button.callback("ðŸ’» LociOne Desk", "app_desk")],
    [Markup.button.url("ðŸŒ Site oficial", LINKS.site)],
    [Markup.button.url("ðŸ“£ Canal de novidades", LINKS.canal)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
  ]);
}

/**
 * Evita erro Telegram 400 "message can't be edited"
 */
async function safeEditOrReply(ctx, text, extra) {
  try {
    if (ctx.update?.callback_query) {
      await ctx.editMessageText(text, extra);
      return;
    }
  } catch (_) {}
  return ctx.reply(text, extra);
}

// ===== Telas =====
async function showFinance(ctx) {
  incStat("open_finance");
  const text =
    "*LociOne Finance ðŸ“±*\n\n" +
    "â€¢ Controle financeiro rÃ¡pido\n" +
    "â€¢ Offline-first (dados no aparelho)\n" +
    "â€¢ RelatÃ³rios e organizaÃ§Ã£o\n\n" +
    "Baixe no iOS:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸŽ App Store (iOS)", LINKS.finance_ios)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

async function showDesk(ctx) {
  incStat("open_desk");
  const text =
    "*LociOne Desk ðŸ’»*\n\n" +
    "â€¢ App desktop offline-first\n" +
    "â€¢ Produtividade com privacidade\n" +
    "â€¢ Downloads oficiais no site\n\n" +
    "FaÃ§a o download:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸ’» Download Desktop", LINKS.desk_download)],
    [Markup.button.callback("ðŸ”” Receber novidades", "sub_on")],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

// ===== /start com deep link payload =====
bot.start(async (ctx) => {
  incStat("start");
  const payload = (ctx.startPayload || "").trim();

  if (payload === "finance") return showFinance(ctx);
  if (payload === "desk") return showDesk(ctx);

  return ctx.reply(
    "ðŸ‘‹ *Bem-vindo Ã  LociOne!*\n\nEscolha o app que vocÃª quer conhecer:",
    { parse_mode: "Markdown", ...mainMenu() }
  );
});

// ===== Comandos =====
bot.command("finance", (ctx) => showFinance(ctx));
bot.command("desk", (ctx) => showDesk(ctx));
bot.command("site", (ctx) => {
  incStat("click_site_cmd");
  return ctx.reply(`ðŸŒ Site oficial: ${LINKS.site}`);
});
bot.command("canal", (ctx) => {
  incStat("click_canal_cmd");
  return ctx.reply(`ðŸ“£ Canal de novidades: ${LINKS.canal}`);
});

bot.command("stats", (ctx) => {
  const stats = readJson(STATS_FILE, {});
  const subs = readJson(SUBS_FILE, { chat_ids: [] });
  const lines = Object.entries(stats)
    .sort((a, b) => b[1] - a[1])
    .map(([k, v]) => `â€¢ ${k}: ${v}`);
  return ctx.reply(
    `ðŸ“Š *Stats*\n\n${lines.length ? lines.join("\n") : "Sem dados ainda."}\n\nðŸ‘¥ inscritos: ${subs.chat_ids.length}`,
    { parse_mode: "Markdown" }
  );
});

bot.command("subscribe", (ctx) => {
  const ok = addSubscriber(ctx.chat.id);
  incStat(ok ? "sub_on_cmd_new" : "sub_on_cmd_existing");
  return ctx.reply(ok ? "âœ… Inscrito nas novidades." : "âœ… VocÃª jÃ¡ estÃ¡ inscrito.");
});

bot.command("unsubscribe", (ctx) => {
  const ok = removeSubscriber(ctx.chat.id);
  incStat(ok ? "sub_off_cmd" : "sub_off_cmd_noop");
  return ctx.reply(ok ? "ðŸ›‘ InscriÃ§Ã£o removida." : "VocÃª nÃ£o estava inscrito.");
});

// ===== BotÃµes =====
bot.action("app_finance", (ctx) => showFinance(ctx));
bot.action("app_desk", (ctx) => showDesk(ctx));

bot.action("sub_on", async (ctx) => {
  const ok = addSubscriber(ctx.chat.id);
  incStat(ok ? "sub_on_new" : "sub_on_existing");
  try {
    await ctx.answerCbQuery(ok ? "Inscrito âœ…" : "VocÃª jÃ¡ estava inscrito âœ…", { show_alert: false });
  } catch {}
  return safeEditOrReply(
    ctx,
    ok ? "âœ… Pronto â€” vocÃª vai receber novidades quando eu enviar." : "âœ… VocÃª jÃ¡ estÃ¡ inscrito nas novidades.",
    { ...mainMenu() }
  );
});

bot.action("back", async (ctx) => {
  try {
    await ctx.editMessageText("Escolha o app que vocÃª quer conhecer:", mainMenu());
  } catch (_) {
    await ctx.reply("Escolha o app que vocÃª quer conhecer:", mainMenu());
  }
});

// ===== Erros =====
bot.catch((err) => console.error("Bot error:", err));

// ===== Start =====
bot.launch();
console.log("ðŸ¤– LociOne Bot rodando (polling)...");
console.log("Deep links:");
console.log(" - https://t.me/locione_bot?start=finance");
console.log(" - https://t.me/locione_bot?start=desk");

process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));import { Telegraf, Markup } from "telegraf";
import "dotenv/config";

const bot = new Telegraf(process.env.BOT_TOKEN);

// ===== Links oficiais =====
const LINKS = {
  finance_ios: "https://apps.apple.com/it/app/locione-finance/id6758838032",
  desk_download: "https://locione.com/download",
  site: "https://locione.com",
  canal: "https://t.me/locione_app",
};

// ===== Menu principal =====
function mainMenu() {
  return Markup.inlineKeyboard([
    [Markup.button.callback("ðŸ“± LociOne Finance", "app_finance")],
    [Markup.button.callback("ðŸ’» LociOne Desk", "app_desk")],
    [Markup.button.url("ðŸŒ Site oficial", LINKS.site)],
    [Markup.button.url("ðŸ“£ Canal de novidades", LINKS.canal)],
  ]);
}

/**
 * Tenta editar a mensagem se o update veio de um botÃ£o (callback).
 * Se nÃ£o der (ou nÃ£o for callback), responde com uma nova mensagem.
 * Isso evita: TelegramError 400 "message can't be edited"
 */
async function safeEditOrReply(ctx, text, extra) {
  try {
    if (ctx.update?.callback_query) {
      await ctx.editMessageText(text, extra);
      return;
    }
  } catch (_) {
    // fallback para reply
  }
  return ctx.reply(text, extra);
}

// ===== Telas =====
async function showFinance(ctx) {
  const text =
    "*LociOne Finance ðŸ“±*\n\n" +
    "â€¢ Controle financeiro rÃ¡pido\n" +
    "â€¢ Offline-first (dados no aparelho)\n" +
    "â€¢ RelatÃ³rios e organizaÃ§Ã£o\n\n" +
    "Baixe no iOS:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸŽ App Store (iOS)", LINKS.finance_ios)],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

async function showDesk(ctx) {
  const text =
    "*LociOne Desk ðŸ’»*\n\n" +
    "â€¢ App desktop offline-first\n" +
    "â€¢ Produtividade com privacidade\n" +
    "â€¢ Downloads oficiais no site\n\n" +
    "FaÃ§a o download:";

  const kb = Markup.inlineKeyboard([
    [Markup.button.url("ðŸ’» Download Desktop", LINKS.desk_download)],
    [Markup.button.callback("â¬…ï¸ Voltar", "back")],
  ]);

  return safeEditOrReply(ctx, text, { parse_mode: "Markdown", ...kb });
}

// ===== /start (com payload: ?start=finance / ?start=desk) =====
bot.start(async (ctx) => {
  const payload = (ctx.startPayload || "").trim();

  if (payload === "finance") return showFinance(ctx);
  if (payload === "desk") return showDesk(ctx);

  return ctx.reply(
    "ðŸ‘‹ *Bem-vindo Ã  LociOne!*\n\nEscolha o app que vocÃª quer conhecer:",
    { parse_mode: "Markdown", ...mainMenu() }
  );
});

// ===== Comandos =====
bot.command("finance", (ctx) => showFinance(ctx));
bot.command("desk", (ctx) => showDesk(ctx));
bot.command("site", (ctx) => ctx.reply(`ðŸŒ Site oficial: ${LINKS.site}`));
bot.command("canal", (ctx) => ctx.reply(`ðŸ“£ Canal de novidades: ${LINKS.canal}`));

// ===== BotÃµes =====
bot.action("app_finance", (ctx) => showFinance(ctx));
bot.action("app_desk", (ctx) => showDesk(ctx));

bot.action("back", async (ctx) => {
  try {
    await ctx.editMessageText("Escolha o app que vocÃª quer conhecer:", mainMenu());
  } catch (_) {
    await ctx.reply("Escolha o app que vocÃª quer conhecer:", mainMenu());
  }
});

// ===== Erros =====
bot.catch((err) => {
  console.error("Bot error:", err);
});

// ===== Start =====
bot.launch();
console.log("ðŸ¤– LociOne Bot rodando (polling)...");
console.log("Deep links:");
console.log(" - https://t.me/locione_bot?start=finance");
console.log(" - https://t.me/locione_bot?start=desk");

// Encerramento limpo
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
